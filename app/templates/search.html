{% extends "base.html" %}

{% block title %}Search - PubliScore{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js" />
<style>
    #map {
        height: 600px;
        width: 100%;
        border-radius: 5px;
    }
    
    .card {
        margin-bottom: 20px;
    }
    
    .recommendations-section {
        margin-top: 20px;
        margin-bottom: 20px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        height: auto;
        display: flex;
        flex-direction: column;
    }
    
    .recommendations-content {
        flex-grow: 1;
        overflow-y: auto;
        padding-right: 10px;
        max-height: 400px;
    }
    
    .recommendations-content::-webkit-scrollbar {
        width: 8px;
    }
    
    .recommendations-content::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
    }
    
    .recommendations-content::-webkit-scrollbar-thumb {
        background: #2196F3;
        border-radius: 4px;
    }
    
    .recommendations-content::-webkit-scrollbar-thumb:hover {
        background: #1976D2;
    }
    
    .progress-bar {
        transition: width 0.3s ease-in-out;
    }
    .transport-list {
        max-height: 300px;
        overflow-y: auto;
    }
    .loading {
        display: none;
        text-align: center;
        padding: 20px;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(255, 255, 255, 0.9);
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        z-index: 1000;
    }
    
    .loading.active {
        display: block;
    }
    
    .loading .spinner-border {
        width: 3rem;
        height: 3rem;
        margin-bottom: 10px;
    }
    
    .loading::after {
        content: "Loading";
        display: block;
        margin-top: 10px;
        color: #2196F3;
        font-weight: bold;
    }
    .score-circle {
        width: 150px;
        height: 150px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto;
        font-size: 3rem;
        font-weight: bold;
        color: white;
        background: linear-gradient(45deg, #2196F3, #9C27B0);
    }
    .transport-item {
        padding: 10px;
        border-bottom: 1px solid #eee;
    }
    .transport-item:last-child {
        border-bottom: none;
    }
    .radius-selector {
        margin-bottom: 15px;
    }
    .legend {
        padding: 4px 6px;
        font: 12px/14px Arial, Helvetica, sans-serif;
        background: white;
        background: rgba(255,255,255,0.8);
        box-shadow: 0 0 15px rgba(0,0,0,0.2);
        border-radius: 4px;
        text-align: left;
        transition: all 0.3s ease;
        min-width: 120px;
    }
    
    .legend h4 {
        margin: 0 0 3px 0;
        text-align: left;
        cursor: pointer;
        user-select: none;
        font-size: 11px;
        display: flex;
        align-items: center;
    }
    
    .legend i {
        width: 12px;
        height: 12px;
        float: left;
        margin-right: 6px;
        opacity: 0.7;
        border-radius: 50%;
    }
    
    .legend div {
        text-align: left;
        margin: 2px 0;
        display: flex;
        align-items: center;
        font-size: 11px;
    }
    
    .legend-content {
        display: none;
        margin-top: 3px;
    }
    
    .legend-content.expanded {
        display: block;
    }
    
    .legend-toggle {
        cursor: pointer;
        padding: 3px;
        border-radius: 3px;
        background: rgba(0,0,0,0.05);
        transition: background 0.2s ease;
    }
    
    .legend-toggle:hover {
        background: rgba(0,0,0,0.1);
    }
    
    input[type="range"] {
        -webkit-appearance: none;
        width: 100%;
        height: 8px;
        border-radius: 4px;
        background: #ddd;
        outline: none;
        margin: 10px 0;
    }
    
    input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #2196F3;
        cursor: pointer;
        transition: background .15s ease-in-out;
    }
    
    input[type="range"]::-webkit-slider-thumb:hover {
        background: #1976D2;
    }
    
    input[type="range"]::-moz-range-thumb {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #2196F3;
        cursor: pointer;
        transition: background .15s ease-in-out;
        border: none;
    }
    
    input[type="range"]::-moz-range-thumb:hover {
        background: #1976D2;
    }
    
    #radiusValue {
        font-weight: bold;
        color: #2196F3;
    }
    
    .editable-value {
        font-weight: bold;
        color: #2196F3;
        width: 60px;
        border: 1px solid #2196F3;
        border-radius: 4px;
        padding: 2px 6px;
        text-align: center;
        background-color: #fff;
        transition: all 0.2s;
    }
    
    .editable-value:focus {
        outline: none;
        box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.2);
    }
    
    .editable-value:hover {
        background-color: rgba(33, 150, 243, 0.1);
    }
    
    .editable-value::-webkit-inner-spin-button,
    .editable-value::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }
    
    .editable-value[type=number] {
        -moz-appearance: textfield;
    }
    
    .heatmap-controls {
        position: absolute;
        bottom: 20px;
        left: 20px;
        z-index: 1000;
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 0 15px rgba(0,0,0,0.2);
        width: 200px;
        text-align: center;
    }
    
    .heatmap-controls label {
        margin-bottom: 5px;
        display: block;
        font-size: 12px;
    }
    
    .heatmap-controls input[type="range"] {
        width: 100%;
        margin: 5px 0;
    }
    
    .heatmap-controls .intensity-value {
        font-size: 12px;
        color: #666;
        text-align: center;
        margin-top: 5px;
    }
    
    .heatmap-controls .btn {
        width: 100%;
        margin-bottom: 10px;
    }
    
    .suggestions-section {
        margin-top: 20px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .suggestions-section h3 {
        color: #2196F3;
        margin-bottom: 15px;
    }
    
    .suggestions-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 15px;
    }
    
    .suggestion-card {
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        border-left: 4px solid #2196F3;
    }
    
    .suggestion-card h4 {
        color: #1976D2;
        margin-bottom: 10px;
        font-size: 1.1em;
    }
    
    .suggestion-card p {
        color: #666;
        font-size: 0.9em;
        margin-bottom: 0;
    }
    
    .suggestion-card .score {
        font-weight: bold;
        color: #2196F3;
        margin-top: 10px;
    }
    
    .recommendations-section {
        margin-top: 20px;
        margin-bottom: 30px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        height: auto;
        display: flex;
        flex-direction: column;
    }
    
    .recommendations-section h3 {
        color: #2196F3;
        margin-bottom: 15px;
        flex-shrink: 0;
    }
    
    .recommendations-content {
        flex-grow: 1;
        overflow-y: auto;
        padding-right: 10px;
        max-height: 400px;
    }
    
    .recommendation-card {
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        margin-bottom: 15px;
        cursor: pointer;
        transition: all 0.3s ease;
        border-left: 4px solid #2196F3;
        height: 180px;
        display: flex;
        flex-direction: column;
    }
    
    .recommendation-card:last-child {
        margin-bottom: 0;
    }
    
    .recommendation-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .recommendation-card h4 {
        color: #1976D2;
        margin-bottom: 10px;
        font-size: 1.1em;
        flex-shrink: 0;
    }
    
    .recommendation-card p {
        color: #666;
        font-size: 0.9em;
        margin-bottom: 10px;
        flex-grow: 1;
        overflow: hidden;
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
    }
    
    .recommendation-card .score {
        font-weight: bold;
        color: #2196F3;
        display: inline-block;
        padding: 4px 8px;
        background: rgba(33, 150, 243, 0.1);
        border-radius: 4px;
        flex-shrink: 0;
    }
    
    .recommendation-card .address {
        color: #666;
        font-size: 0.9em;
        margin-top: 5px;
        flex-shrink: 0;
    }
    
    footer {
        margin-top: 50px;
        padding: 20px 0;
        background-color: #f8f9fa;
        border-top: 1px solid #dee2e6;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">Search Location</h5>
                    <form id="searchForm" class="mb-3">
                        <div class="form-group mb-3">
                            <label for="address" class="form-label">Address</label>
                            <input type="text" class="form-control" id="address" placeholder="Enter an address in Antwerp" autocomplete="off">
                        </div>
                        <div class="mb-3">
                            <label for="radius" class="form-label">Search Radius: 
                                <input type="number" id="radiusValue" class="form-control" style="width: 80px; display: inline-block;" value="1.0" min="0.5" max="3.0" step="0.1"> km
                            </label>
                            <input type="range" class="form-range" id="radius" min="0.5" max="3.0" step="0.1" value="1.0">
                        </div>
                        <div class="mb-3">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="showIsochrone" checked="false">
                                <label class="form-check-label" for="showIsochrone">
                                    Show reachable areas within time limit
                                </label>
                            </div>
                            <div id="travelTimeControls" style="display: none;">
                                <label for="travelTime" class="form-label">Travel Time Limit: 
                                    <input type="number" id="travelTimeValue" class="form-control" style="width: 80px; display: inline-block;" value="15" min="5" max="60" step="5"> min
                                </label>
                                <input type="range" class="form-range" id="travelTime" min="5" max="60" step="5" value="15">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Search</button>
                    </form>
                </div>
            </div>
            
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">Accessibility Score</h5>
                    <div id="scoreDisplay" class="text-center">
                        <div class="score-container">
                            <div class="score-circle mb-3">
                                <span id="scoreValue">-</span>
                            </div>
                        </div>
                        <div class="progress mb-3">
                            <div id="scoreBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                        </div>
                        <p id="scoreDescription" class="text-muted">Select a location to see the score</p>
                    </div>
                </div>
            </div>
            
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">Location Description</h5>
                    <div id="locationDescription" class="text-muted">
                        Select a location to see its description
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Transport Details</h5>
                    <div id="transportDetails">
                        <p class="text-muted">Select a location to see transport details</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-8">
            <div class="card">
                <div class="card-body">
                    <div id="map"></div>
                    <div class="heatmap-controls">
                        <button id="toggleHeatmap" class="btn btn-primary">Show Heatmap</button>
                        <div id="intensityControls" style="display: none;">
                            <label for="heatmapIntensity">Heatmap Intensity</label>
                            <input type="range" class="form-range" id="heatmapIntensity" min="1" max="50" value="25">
                            <div class="intensity-value">25</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="recommendations-section">
                <h3>Recommended Locations</h3>
                <div class="recommendations-content" id="recommendationsContent">
                    <p class="text-muted">Loading recommendations...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="loading">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
<script src="{{ url_for('static', filename='js/address-autocomplete.js') }}"></script>
<script>
    console.log('Main script loaded');
    let map;
    let marker;
    let circle;
    let transportMarkers = [];
    let lastLocation = null;
    let lastRadius = null;
    let heatmapLayer = null;
    let isHeatmapVisible = false;
    let currentHeatmapData = null;
    let isochroneLayer = null;
    let isochroneLegend = null;
    
    document.addEventListener('DOMContentLoaded', function() {
        map = L.map('map').setView([51.2195, 4.4025], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);
        
        loadRecommendations();
        
        const legend = L.control({position: 'bottomright'});
        legend.onAdd = function(map) {
            const div = L.DomUtil.create('div', 'legend');
            div.innerHTML = `
                <h4>Transport Types</h4>
                <div><i style="background: #2196F3"></i> Bus Stop</div>
                <div><i style="background: #9C27B0"></i> Tram Stop</div>
                <div><i style="background: #FF9800"></i> Velo Station</div>
                <div><i style="background: linear-gradient(to right, #ff0000, #ffff00, #00ff00)"></i> Transport Density</div>
            `;
            return div;
        };
        legend.addTo(map);
        
        map.on('click', function(e) {
            updateLocation(e.latlng.lat, e.latlng.lng);
        });
        
        document.getElementById('searchForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const address = document.getElementById('address').value;
            if (address) {
                searchAddress(address);
            }
        });
        
        const radiusSlider = document.getElementById('radius');
        const radiusValue = document.getElementById('radiusValue');
        
        radiusSlider.addEventListener('input', function() {
            radiusValue.value = this.value;
            if (marker) {
                const latlng = marker.getLatLng();
                updateLocation(latlng.lat, latlng.lng);
            }
        });
        
        radiusValue.addEventListener('change', function() {
            let value = parseFloat(this.value);
            
            if (isNaN(value)) {
                value = 1.0;
            }
            value = Math.max(0.5, Math.min(3.0, value));
            value = Math.round(value * 10) / 10;
            
            this.value = value.toFixed(1);
            radiusSlider.value = value;
            
            if (marker) {
                const latlng = marker.getLatLng();
                updateLocation(latlng.lat, latlng.lng);
            }
        });
        
        const travelTimeSlider = document.getElementById('travelTime');
        const travelTimeValue = document.getElementById('travelTimeValue');
        const showIsochroneCheckbox = document.getElementById('showIsochrone');
        const travelTimeControls = document.getElementById('travelTimeControls');
        
        if (!travelTimeSlider || !travelTimeValue || !showIsochroneCheckbox || !travelTimeControls) {
            console.error("Travel time controls not found in DOM");
            return;
        }
        
        showIsochroneCheckbox.checked = false;
        travelTimeControls.style.display = 'none';
        
        showIsochroneCheckbox.addEventListener('change', function() {
            travelTimeControls.style.display = this.checked ? 'block' : 'none';
            if (this.checked && marker) {
                const latlng = marker.getLatLng();
                updateIsochrone(latlng.lat, latlng.lng);
            } else if (isochroneLayer) {
                map.removeLayer(isochroneLayer);
                if (isochroneLegend) {
                    map.removeControl(isochroneLegend);
                }
            }
        });
        
        travelTimeSlider.addEventListener('input', function() {
            travelTimeValue.value = this.value;
            if (showIsochroneCheckbox.checked && marker) {
                const latlng = marker.getLatLng();
                updateIsochrone(latlng.lat, latlng.lng);
            }
        });
        
        travelTimeValue.addEventListener('change', function() {
            let value = parseInt(this.value);
            
            if (isNaN(value)) {
                value = 15;
            }
            value = Math.max(5, Math.min(60, value));
            value = Math.round(value / 5) * 5;
            
            this.value = value;
            travelTimeSlider.value = value;
            
            if (showIsochroneCheckbox.checked && marker) {
                const latlng = marker.getLatLng();
                updateIsochrone(latlng.lat, latlng.lng);
            }
        });
    });
    
    function updateLocation(lat, lng) {
        if (marker) {
            marker.setLatLng([lat, lng]);
        } else {
            marker = L.marker([lat, lng]).addTo(map);
        }
        
        const radius = parseFloat(document.getElementById('radius').value) * 1000;
        if (circle) {
            circle.setLatLng([lat, lng]).setRadius(radius);
        } else {
            circle = L.circle([lat, lng], {
                radius: radius,
                color: '#0d6efd',
                fillColor: '#0d6efd',
                fillOpacity: 0.1
            }).addTo(map);
        }
        
        const currentLocation = `${lat.toFixed(4)}_${lng.toFixed(4)}`;
        const currentRadius = document.getElementById('radius').value;
        
        if (currentLocation !== lastLocation || currentRadius !== lastRadius) {
            lastLocation = currentLocation;
            lastRadius = currentRadius;
            calculateScore(lat, lng);
        }
        
        const showIsochroneCheckbox = document.getElementById('showIsochrone');
        if (showIsochroneCheckbox && showIsochroneCheckbox.checked) {
            updateIsochrone(lat, lng);
        }
    }
    
    function searchAddress(address) {
        document.querySelector('.loading').classList.add('active');
        
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}, Antwerp, Belgium`)
            .then(response => response.json())
            .then(data => {
                if (data && data.length > 0) {
                    const result = data[0];
                    updateLocation(parseFloat(result.lat), parseFloat(result.lon));
                    map.setView([result.lat, result.lon], 16);
                } else {
                    alert('Address not found');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error searching address');
            })
            .finally(() => {
                document.querySelector('.loading').classList.remove('active');
            });
    }
    
    function calculateScore(lat, lng) {
        document.querySelector('.loading').classList.add('active');
        
        const radius = document.getElementById('radius').value;
        
        fetch(`/api/score?lat=${lat}&lon=${lng}&radius=${radius}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                updateScoreDisplay(data);
                displayTransportNodes(data.transport_nodes);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error calculating score: ' + error.message);
            })
            .finally(() => {
                document.querySelector('.loading').classList.remove('active');
            });
    }
    
    function updateScoreDisplay(data) {
        const scoreValue = document.getElementById('scoreValue');
        const scoreBar = document.getElementById('scoreBar');
        const scoreDescription = document.getElementById('scoreDescription');
        const transportDetails = document.getElementById('transportDetails');
        const locationDescription = document.getElementById('locationDescription');
        
        const details = data.details;
        
        fetch(`/api/location_info?lat=${data.lat}&lon=${data.lon}`)
            .then(response => response.json())
            .then(locationData => {
                const busScore = Math.min(3, details.bus_stops * 0.3);
                const tramScore = Math.min(4, details.tram_stops * 0.4);
                const veloScore = Math.min(2, details.velo_stations * 0.2);
                
                const busDistanceScore = details.closest_bus ? 
                    Math.min(1, (2 - Math.min(details.closest_bus, 2)) * 0.5) : 0;
                const tramDistanceScore = details.closest_tram ? 
                    Math.min(1, (1.5 - Math.min(details.closest_tram, 1.5)) * 0.67) : 0;
                const veloDistanceScore = details.closest_velo ? 
                    Math.min(1, (2 - Math.min(details.closest_velo, 2)) * 0.5) : 0;

                const delijnPenalties = calculateDeLijnPenalties(locationData);
                
                const locationPenalties = calculateLocationPenalties(locationData);
                
                const baseScore = busScore + tramScore + veloScore + 
                                busDistanceScore + tramDistanceScore + veloDistanceScore;
                
                const missingTransportPenalty = 
                    (details.bus_stops === 0 ? 1 : 0) + 
                    (details.tram_stops === 0 ? 2 : 0) + 
                    (details.velo_stations === 0 ? 1 : 0);
                
                const geminiScore = Math.max(0, Math.min(10, 
                    baseScore - missingTransportPenalty - delijnPenalties - locationPenalties
                ));

                const averageScore = (data.score + geminiScore) / 2;
                
                scoreValue.textContent = averageScore.toFixed(1);
                scoreBar.style.width = `${averageScore * 10}%`;
                
                let description = '';
                if (averageScore >= 8) {
                    description = 'Excellent public transport accessibility';
                } else if (averageScore >= 6) {
                    description = 'Good public transport accessibility';
                } else if (averageScore >= 4) {
                    description = 'Moderate public transport accessibility';
                } else if (averageScore >= 2) {
                    description = 'Limited public transport accessibility';
                } else {
                    description = 'Poor public transport accessibility';
                }
                scoreDescription.textContent = description;

                let locationDesc = '';
                if (averageScore >= 8) {
                    locationDesc = `This location offers excellent public transport accessibility with ${details.bus_stops} bus stops, ${details.tram_stops} tram stops, and ${details.velo_stations} velo stations nearby. The area has high-quality De Lijn service and good infrastructure.`;
                } else if (averageScore >= 6) {
                    locationDesc = `This location provides good public transport accessibility with ${details.bus_stops} bus stops, ${details.tram_stops} tram stops, and ${details.velo_stations} velo stations in the area. The De Lijn service is reliable and the infrastructure is well-maintained.`;
                } else if (averageScore >= 4) {
                    locationDesc = `This location has moderate public transport accessibility with ${details.bus_stops} bus stops, ${details.tram_stops} tram stops, and ${details.velo_stations} velo stations. The De Lijn service is adequate but could be improved.`;
                } else if (averageScore >= 2) {
                    locationDesc = `This location has limited public transport accessibility with only ${details.bus_stops} bus stops, ${details.tram_stops} tram stops, and ${details.velo_stations} velo stations. The De Lijn service is infrequent and the infrastructure needs improvement.`;
                } else {
                    locationDesc = `This location has poor public transport accessibility with minimal transport options (${details.bus_stops} bus stops, ${details.tram_stops} tram stops, ${details.velo_stations} velo stations). The De Lijn service is unreliable and the infrastructure is inadequate.`;
                }
                locationDescription.textContent = locationDesc;
            })
            .catch(error => {
                console.error('Error fetching location data:', error);
                scoreValue.textContent = data.score.toFixed(1);
                scoreBar.style.width = `${data.score * 10}%`;
                
                let description = '';
                if (data.score >= 8) {
                    description = 'Excellent public transport accessibility';
                } else if (data.score >= 6) {
                    description = 'Good public transport accessibility';
                } else if (data.score >= 4) {
                    description = 'Moderate public transport accessibility';
                } else if (data.score >= 2) {
                    description = 'Limited public transport accessibility';
                } else {
                    description = 'Poor public transport accessibility';
                }
                scoreDescription.textContent = description;

                let locationDesc = '';
                if (data.score >= 8) {
                    locationDesc = `This location offers excellent public transport accessibility with ${details.bus_stops} bus stops, ${details.tram_stops} tram stops, and ${details.velo_stations} velo stations nearby.`;
                } else if (data.score >= 6) {
                    locationDesc = `This location provides good public transport accessibility with ${details.bus_stops} bus stops, ${details.tram_stops} tram stops, and ${details.velo_stations} velo stations in the area.`;
                } else if (data.score >= 4) {
                    locationDesc = `This location has moderate public transport accessibility with ${details.bus_stops} bus stops, ${details.tram_stops} tram stops, and ${details.velo_stations} velo stations.`;
                } else if (data.score >= 2) {
                    locationDesc = `This location has limited public transport accessibility with only ${details.bus_stops} bus stops, ${details.tram_stops} tram stops, and ${details.velo_stations} velo stations.`;
                } else {
                    locationDesc = `This location has poor public transport accessibility with minimal transport options (${details.bus_stops} bus stops, ${details.tram_stops} tram stops, ${details.velo_stations} velo stations).`;
                }
                locationDescription.textContent = locationDesc;
            });
        
        transportDetails.innerHTML = `
            <div class="transport-list">
                <div class="transport-item">
                    <strong>Bus Stops:</strong> ${details.bus_stops}
                    ${details.closest_bus !== null && details.closest_bus !== undefined ? 
                        `<br>Closest: ${parseFloat(details.closest_bus).toFixed(2)} km` : 
                        '<br>No bus stops in range'}
                </div>
                <div class="transport-item">
                    <strong>Tram Stops:</strong> ${details.tram_stops}
                    ${details.closest_tram !== null && details.closest_tram !== undefined ? 
                        `<br>Closest: ${parseFloat(details.closest_tram).toFixed(2)} km` : 
                        '<br>No tram stops in range'}
                </div>
                <div class="transport-item">
                    <strong>Velo Stations:</strong> ${details.velo_stations}
                    ${details.closest_velo !== null && details.closest_velo !== undefined ? 
                        `<br>Closest: ${parseFloat(details.closest_velo).toFixed(2)} km` : 
                        '<br>No velo stations in range'}
                </div>
            </div>
        `;
    }
    
    function calculateDeLijnPenalties(locationData) {
        let penalties = 0;
        
        if (locationData.delijn_frequency === 'low') penalties += 1;
        if (locationData.delijn_frequency === 'medium') penalties += 0.5;
        
        if (locationData.delijn_reliability < 0.8) penalties += 0.5;
        if (locationData.delijn_reliability < 0.6) penalties += 0.5;
        
        if (locationData.delijn_coverage === 'poor') penalties += 1;
        if (locationData.delijn_coverage === 'fair') penalties += 0.5;
        
        return Math.min(3, penalties);
    }

    function calculateLocationPenalties(locationData) {
        let penalties = 0;
        
        if (locationData.neighborhood_quality === 'poor') penalties += 1;
        if (locationData.neighborhood_quality === 'fair') penalties += 0.5;
        
        if (!locationData.has_sidewalks) penalties += 0.7;
        if (!locationData.has_bike_lanes) penalties += 0.7;
        if (!locationData.has_crosswalks) penalties += 0.6;
        
        if (locationData.safety_rating < 7) penalties += 0.5;
        if (locationData.safety_rating < 5) penalties += 0.5;
        
        return Math.min(4, penalties);
    }

    function calculateBasicScore(details) {
        const busScore = Math.min(3, details.bus_stops * 0.3);
        const tramScore = Math.min(4, details.tram_stops * 0.4);
        const veloScore = Math.min(2, details.velo_stations * 0.2);
        
        const busDistanceScore = details.closest_bus ? 
            Math.min(1, (2 - Math.min(details.closest_bus, 2)) * 0.5) : 0;
        const tramDistanceScore = details.closest_tram ? 
            Math.min(1, (1.5 - Math.min(details.closest_tram, 1.5)) * 0.67) : 0;
        const veloDistanceScore = details.closest_velo ? 
            Math.min(1, (2 - Math.min(details.closest_velo, 2)) * 0.5) : 0;

        const missingTransportPenalty = 
            (details.bus_stops === 0 ? 1 : 0) + 
            (details.tram_stops === 0 ? 2 : 0) + 
            (details.velo_stations === 0 ? 1 : 0);

        return Math.max(0, Math.min(10, 
            busScore + tramScore + veloScore + 
            busDistanceScore + tramDistanceScore + veloDistanceScore - 
            missingTransportPenalty
        ));
    }
    
    function displayTransportNodes(transportNodes) {
        transportMarkers.forEach(marker => {
            if (marker && map.hasLayer(marker)) {
                map.removeLayer(marker);
            }
        });
        transportMarkers = [];
        
        const relevantNodes = transportNodes.filter(node => 
            node.transport_type === 'bus_stop' || 
            node.transport_type === 'tram_stop' || 
            node.transport_type === 'velo_station'
        );
        
        relevantNodes.forEach(node => {
            let markerColor;
            
            switch(node.transport_type) {
                case 'bus_stop':
                    markerColor = '#2196F3';
                    break;
                case 'tram_stop':
                    markerColor = '#9C27B0';
                    break;
                case 'velo_station':
                    markerColor = '#FF9800';
                    break;
                default:
                    return;
            }
            
            const icon = L.divIcon({
                className: 'transport-marker',
                html: `<div style="background-color: ${markerColor}; width: 12px; height: 12px; border-radius: 50%; border: 2px solid #ffffff; box-shadow: 0 0 4px rgba(0,0,0,0.3);"></div>`,
                iconSize: [16, 16],
                iconAnchor: [8, 8]
            });
            
            const transportMarker = L.marker([node.lat, node.lon], {icon: icon})
                .bindPopup(`
                    <div style="min-width: 150px;">
                        <b style="color: ${markerColor};">${node.transport_type.replace('_', ' ').toUpperCase()}</b><br>
                        Distance: ${parseFloat(node.distance).toFixed(2)} km<br>
                        ID: ${node.id}
                    </div>
                `, {
                    maxWidth: 200,
                    className: 'custom-popup'
                });
            
            transportMarker.addTo(map);
            transportMarkers.push(transportMarker);
        });
    }
    
    const toggleHeatmap = document.getElementById('toggleHeatmap');
    const intensityControls = document.getElementById('intensityControls');
    const heatmapIntensity = document.getElementById('heatmapIntensity');
    const intensityValue = document.querySelector('.intensity-value');
    
    heatmapIntensity.addEventListener('input', function() {
        intensityValue.textContent = this.value;
        if (currentHeatmapData && isHeatmapVisible) {
            updateHeatmap(currentHeatmapData);
        }
    });
    
    toggleHeatmap.addEventListener('click', function() {
        isHeatmapVisible = !isHeatmapVisible;
        this.textContent = isHeatmapVisible ? 'Hide Heatmap' : 'Show Heatmap';
        intensityControls.style.display = isHeatmapVisible ? 'block' : 'none';
        
        if (isHeatmapVisible) {
            document.querySelector('.loading').classList.add('active');
            
            fetch('/api/all_transport_nodes')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.text().then(text => {
                        try {
                            return JSON.parse(text);
                        } catch (e) {
                            console.error('Raw response:', text);
                            throw new Error(`JSON parse error: ${e.message}`);
                        }
                    });
                })
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    if (!data.transport_nodes || !Array.isArray(data.transport_nodes)) {
                        throw new Error('Invalid data format received from server');
                    }
                    console.log('Received nodes:', data.transport_nodes.length);
                    currentHeatmapData = data.transport_nodes;
                    updateHeatmap(currentHeatmapData);
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error loading heatmap data: ' + error.message);
                    isHeatmapVisible = false;
                    this.textContent = 'Show Heatmap';
                    intensityControls.style.display = 'none';
                })
                .finally(() => {
                    document.querySelector('.loading').classList.remove('active');
                });
        } else if (heatmapLayer) {
            map.removeLayer(heatmapLayer);
        }
    });
    
    function updateHeatmap(transportNodes) {
        try {
            if (heatmapLayer) {
                map.removeLayer(heatmapLayer);
            }
            
            console.log('Creating heatmap with nodes:', transportNodes.length);
            
            const intensity = parseInt(heatmapIntensity.value);
            
            const heatmapData = transportNodes.map(node => {
                try {
                    const lat = parseFloat(node.lat);
                    const lon = parseFloat(node.lon);
                    
                    if (isNaN(lat) || isNaN(lon)) {
                        console.warn('Invalid coordinates:', node);
                        return null;
                    }
                    
                    if (lat < -90 || lat > 90 || lon < -180 || lon > 180) {
                        console.warn('Coordinates out of range:', node);
                        return null;
                    }
                    
                    let baseIntensity = 1;
                    switch(node.transport_type) {
                        case 'bus_stop':
                            baseIntensity = 0.8;
                            break;
                        case 'tram_stop':
                            baseIntensity = 1.2;
                            break;
                        case 'velo_station':
                            baseIntensity = 0.6;
                            break;
                        default:
                            console.warn('Unknown transport type:', node.transport_type);
                            return null;
                    }
                    
                    const adjustedIntensity = baseIntensity * (intensity / 25);
                    
                    return [lat, lon, adjustedIntensity];
                } catch (e) {
                    console.warn('Error processing node:', node, e);
                    return null;
                }
            }).filter(point => point !== null);
            
            console.log('Valid heatmap points:', heatmapData.length);
            
            if (heatmapData.length === 0) {
                throw new Error('No valid transport nodes found');
            }
            
            heatmapLayer = L.heatLayer(heatmapData, {
                radius: intensity,
                blur: intensity * 0.6,
                maxZoom: 10,
                max: 1.0,
                gradient: {
                    0.4: 'blue',
                    0.6: 'lime',
                    0.8: 'yellow',
                    1.0: 'red'
                }
            });
            
            if (isHeatmapVisible) {
                map.addLayer(heatmapLayer);
            }
        } catch (error) {
            console.error('Error creating heatmap:', error);
            alert('Error creating heatmap: ' + error.message);
        }
    }
    
    function getAreaSuggestions(lat, lng) {
        document.querySelector('.loading').classList.add('active');
        
        fetch(`/api/score?lat=${lat}&lon=${lng}&radius=${document.getElementById('radius').value}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                updateSuggestions(data);
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('suggestionsContent').innerHTML = 
                    `<p class="text-danger">Error loading suggestions: ${error.message}</p>`;
            })
            .finally(() => {
                document.querySelector('.loading').classList.remove('active');
            });
    }
    
    function updateSuggestions(data) {
        const suggestionsContent = document.getElementById('suggestionsContent');
        
        if (!data.location_description) {
            suggestionsContent.innerHTML = '<p class="text-muted">No suggestions available for this area</p>';
            return;
        }
        
        let html = '<div class="suggestions-grid">';
        
        html += `
            <div class="suggestion-card">
                <h4>Area Overview</h4>
                <p>${data.location_description}</p>
                <div class="score">Accessibility Score: ${data.score.toFixed(1)}/10</div>
            </div>
        `;
        
        const details = data.details;
        html += `
            <div class="suggestion-card">
                <h4>Transport Options</h4>
                <p>
                    <strong>Bus Stops:</strong> ${details.bus_stops}<br>
                    <strong>Tram Stops:</strong> ${details.tram_stops}<br>
                    <strong>Velo Stations:</strong> ${details.velo_stations}
                </p>
            </div>
        `;
        
        let recommendation = '';
        if (data.score >= 8) {
            recommendation = 'This is an excellent location for public transport accessibility. Consider this area if you rely heavily on public transportation.';
        } else if (data.score >= 6) {
            recommendation = 'This area offers good public transport options. It\'s a solid choice for regular public transport users.';
        } else if (data.score >= 4) {
            recommendation = 'The public transport coverage is moderate. Consider this area if you have alternative transport options available.';
        } else if (data.score >= 2) {
            recommendation = 'Public transport options are limited in this area. You might want to consider locations with better connectivity.';
        } else {
            recommendation = 'This area has poor public transport accessibility. Consider looking at other locations with better transport options.';
        }
        
        html += `
            <div class="suggestion-card">
                <h4>Recommendation</h4>
                <p>${recommendation}</p>
            </div>
        `;
        
        html += '</div>';
        suggestionsContent.innerHTML = html;
    }
    
    function loadRecommendations() {
        document.querySelector('.loading').classList.add('active');
        
        fetch('/api/recommendations')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                updateRecommendations(data.recommendations);
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('recommendationsContent').innerHTML = 
                    `<p class="text-danger">Error loading recommendations: ${error.message}</p>`;
            })
            .finally(() => {
                document.querySelector('.loading').classList.remove('active');
            });
    }
    
    function updateRecommendations(recommendations) {
        const recommendationsContent = document.getElementById('recommendationsContent');
        
        if (!recommendations || recommendations.length === 0) {
            recommendationsContent.innerHTML = '<p class="text-muted">No recommendations available</p>';
            return;
        }
        
        let html = '';
        recommendations.forEach(rec => {
            html += `
                <div class="recommendation-card" onclick="viewRecommendation(${rec.lat}, ${rec.lon}, '${rec.address}')">
                    <h4>${rec.title}</h4>
                    <p>${rec.description}</p>
                    <div class="score">Accessibility Score: ${rec.score.toFixed(1)}/10</div>
                    <div class="address">
                        <i class="fas fa-map-marker-alt"></i> ${rec.address}
                    </div>
                </div>
            `;
        });
        
        recommendationsContent.innerHTML = html;
    }
    
    function viewRecommendation(lat, lon, address) {
        map.setView([lat, lon], 16);
        
        updateLocation(lat, lon);
        
        document.getElementById('address').value = address;
    }
    
    function updateIsochrone(lat, lng) {
        const travelTimeElement = document.getElementById('travelTime');
        const showIsochroneElement = document.getElementById('showIsochrone');
        const loadingElement = document.querySelector('.loading');
        
        if (!travelTimeElement || !showIsochroneElement) {
            console.error("Travel time controls not found");
            return;
        }
        
        if (loadingElement) {
            loadingElement.classList.add('active');
        }
        
        const travelTime = parseInt(travelTimeElement.value);
        console.log(`Calculating isochrone: lat=${lat}, lon=${lng}, time=${travelTime}`);
        
        try {
            if (isochroneLayer) {
                map.removeLayer(isochroneLayer);
            }
            
            if (isochroneLegend) {
                map.removeControl(isochroneLegend);
            }
            
            isochroneLayer = L.layerGroup().addTo(map);
            
            const transportModes = [
                { type: 'tram', speed: 20, color: '#9C27B0' },
                { type: 'bus', speed: 15, color: '#2196F3' },
                { type: 'bike', speed: 12, color: '#4CAF50' },
                { type: 'walk', speed: 5, color: '#FF9800' }
            ];
            
            const circles = [];
            transportModes.forEach(mode => {
                const radiusKm = (mode.speed * travelTime / 60.0);
                const radiusMeters = radiusKm * 1000;
                
                const circle = L.circle([lat, lng], {
                    radius: radiusMeters,
                    color: mode.color,
                    weight: 2,
                    opacity: 0.6,
                    fillColor: mode.color,
                    fillOpacity: 0.1,
                    interactive: false
                }).addTo(isochroneLayer);
                
                circles.push(circle);
                
                circle.bindPopup(`
                    <div style="text-align: center;">
                        <strong>${mode.type.charAt(0).toUpperCase() + mode.type.slice(1)}</strong><br>
                        Travel Time: ${travelTime} minutes<br>
                        Maximum distance: ${radiusKm.toFixed(2)} km<br>
                        Average speed: ${mode.speed} km/h
                    </div>
                `);
            });
            
            isochroneLegend = L.control({ position: 'bottomright' });
            isochroneLegend.onAdd = function(map) {
                const div = L.DomUtil.create('div', 'legend');
                div.innerHTML = `
                    <div class="legend-content expanded">
                        ${transportModes.map(mode => `
                            <div style="display: block; margin: 4px 0;">
                                <i style="background: ${mode.color}"></i>
                                <span>${mode.type.charAt(0).toUpperCase() + mode.type.slice(1)} (${mode.speed} km/h)</span>
                            </div>
                        `).join('')}
                    </div>
                `;
                
                return div;
            };
            isochroneLegend.addTo(map);
            
            if (circles.length > 0) {
                const bounds = L.latLngBounds(circles.map(circle => circle.getBounds()));
                map.fitBounds(bounds, {
                    padding: [50, 50],
                    maxZoom: 15
                });
            }
            
            console.log(`Created isochrones for ${travelTime} minutes`);
        } catch (error) {
            console.error('Error creating isochrones:', error);
            alert('Error calculating reachable areas: ' + error.message);
            
            if (showIsochroneElement) {
                showIsochroneElement.checked = false;
            }
        } finally {
            if (loadingElement) {
                loadingElement.classList.remove('active');
            }
        }
    }
</script>
{% endblock %} 